<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>飲食店 横断検索リンク生成</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Arial, sans-serif; line-height: 1.5; margin: 24px; }
    h1 { margin: 0 0 12px; font-size: 20px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input[type="text"] { padding: 10px 12px; font-size: 16px; }
    #q { min-width: min(420px, 100%); }
    #region { min-width: min(220px, 100%); }
    button { padding: 10px 12px; font-size: 14px; cursor: pointer; }
    .sites { margin: 14px 0 10px; display: grid; gap: 8px; }
    .sites label { display: flex; gap: 8px; align-items: center; }
    ul { padding-left: 18px; }
    li { margin: 6px 0; }
    .muted { color:#666; font-size: 12px; }
    .box { border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin-top: 14px; }
    .history { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .chip {
      border: 1px solid #ddd; border-radius: 999px;
      padding: 6px 10px; background: #fff; cursor: pointer;
      font-size: 13px;
    }
    .chip:hover { background: #f7f7f7; }
    .chip small { color:#666; margin-left: 6px; }
    .spacer { flex: 1; }
  </style>
</head>
<body>
  <h1>飲食店 横断検索リンク生成</h1>

  <div class="row">
    <input id="q" type="text" placeholder="店名（例：〇〇食堂）" />
    <input id="region" type="text" placeholder="地域（例：渋谷 / 新宿 / 横浜）※任意" />
    <button id="gen">リンク生成</button>
  </div>

  <div class="box">
    <div class="row">
      <div class="muted">検索先（チェックしたものだけリンク生成）</div>
      <div class="spacer"></div>
      <button id="checkAll" title="全サイトにチェック">全選択</button>
      <button id="uncheckAll" title="全サイトのチェックを外す">全解除</button>
    </div>
    <div id="sites" class="sites"></div>
  </div>

  <div class="box">
    <div class="row">
      <div class="muted">検索履歴（タップで再検索）</div>
      <div class="spacer"></div>
      <button id="clearHistory">履歴をクリア</button>
    </div>
    <div id="history" class="history"></div>
  </div>

  <div class="box">
    <div class="muted">生成リンク</div>
    <ul id="out"></ul>
  </div>

<script>
  const enc = (s) => encodeURIComponent((s ?? "").trim());

  // --- localStorage keys ---
  const STORAGE_KEYS = {
    sitePrefs: "xb_site_prefs_v1",
    history: "xb_history_v1",
  };

  // --- helpers ---
  const safeJsonParse = (s, fallback) => {
    try { return JSON.parse(s); } catch { return fallback; }
  };

  // ハッシュタグ用：#や空白などを除去してタグ化（地域は入れない）
  const normalizeHashtag = (s) =>
    (s ?? "")
      .trim()
      .replace(/[＃#]/g, "")
      .replace(/\s+/g, "")
      .replace(/[・.]/g, "");

  // クエリ組み立て（多くのサイトは「店名 + 地域」が強い）
  const buildQuery = (name, region) => {
    const n = (name ?? "").trim();
    const r = (region ?? "").trim();
    return r ? `${n} ${r}` : n;
  };

  // --- サイト定義（追加はここ） ---
  // build(ctx): ctx = { name, region, query }
  const SITES = [
    { id: "tabelog", label: "食べログ（サイト内検索）",
      build: (ctx) => `https://tabelog.com/rstLst/?sk=${enc(ctx.query)}&sw=${enc(ctx.query)}` },

    { id: "gnavi", label: "ぐるなび（サイト内検索）",
      build: (ctx) => `https://r.gnavi.co.jp/area/jp/rs/?fw=${enc(ctx.query)}` },

    { id: "hotpepper", label: "ホットペッパー（Google site:）",
      build: (ctx) => `https://www.google.com/search?q=${enc(`site:hotpepper.jp ${ctx.query}`)}` },

    { id: "gmap", label: "Googleマップ",
      build: (ctx) => `https://www.google.com/maps/search/?api=1&query=${enc(ctx.query)}` },

    { id: "yahoomap", label: "Yahoo!マップ",
      build: (ctx) => `https://map.yahoo.co.jp/search?q=${enc(ctx.query)}` },

    { id: "kufu_trip", label: "くふうトリップ（Google site:）",
      build: (ctx) => `https://www.google.com/search?q=${enc(`site:retrip.jp OR site:rtrp.jp ${ctx.query}`)}` },

    { id: "tripadvisor", label: "TripAdvisor（Google site:）",
      build: (ctx) => `https://www.google.com/search?q=${enc(`site:tripadvisor.jp ${ctx.query}`)}` },

    { id: "retty", label: "Retty（Google site:）",
      build: (ctx) => `https://www.google.com/search?q=${enc(`site:retty.me ${ctx.query}`)}` },

    { id: "instagram_hashtag", label: "Instagram（#ハッシュタグ）",
      build: (ctx) => {
        const tag = normalizeHashtag(ctx.name); // 店名だけをタグに
        if (!tag) return `https://www.google.com/search?q=${enc(`site:instagram.com ${ctx.query}`)}`;
        return `https://www.instagram.com/explore/tags/${encodeURIComponent(tag)}/`;
      } },

    { id: "instagram_google_tag", label: "Instagram（Googleで #検索）",
      build: (ctx) => `https://www.google.com/search?q=${enc(`site:instagram.com "#${ctx.name}" ${ctx.region ? ctx.region : ""}`)}` },
  ];

  // --- DOM ---
  const $sites = document.getElementById("sites");
  const $q = document.getElementById("q");
  const $region = document.getElementById("region");
  const $out = document.getElementById("out");
  const $history = document.getElementById("history");

  // --- prefs load/save ---
  function loadSitePrefs() {
    const raw = localStorage.getItem(STORAGE_KEYS.sitePrefs);
    return safeJsonParse(raw, null); // null => default
  }
  function saveSitePrefs(prefs) {
    localStorage.setItem(STORAGE_KEYS.sitePrefs, JSON.stringify(prefs));
  }
  function collectSitePrefsFromUI() {
    const prefs = {};
    for (const cb of $sites.querySelectorAll("input[type=checkbox]")) {
      prefs[cb.dataset.siteId] = cb.checked;
    }
    return prefs;
  }

  // --- history load/save/render ---
  function loadHistory() {
    const raw = localStorage.getItem(STORAGE_KEYS.history);
    const arr = safeJsonParse(raw, []);
    return Array.isArray(arr) ? arr : [];
  }
  function saveHistory(arr) {
    localStorage.setItem(STORAGE_KEYS.history, JSON.stringify(arr));
  }
  function formatHistoryLabel(item) {
    const base = item.name;
    return item.region ? `${base}（${item.region}）` : base;
  }
  function renderHistory() {
    const items = loadHistory();
    $history.innerHTML = "";
    if (!items.length) {
      const span = document.createElement("span");
      span.className = "muted";
      span.textContent = "まだ履歴はありません";
      $history.appendChild(span);
      return;
    }
    for (const it of items) {
      const btn = document.createElement("button");
      btn.className = "chip";
      btn.type = "button";
      btn.textContent = formatHistoryLabel(it);
      btn.addEventListener("click", () => {
        $q.value = it.name;
        $region.value = it.region ?? "";
        generateLinks(true); // history click
      });
      $history.appendChild(btn);
    }
  }
  function addToHistory(name, region) {
    const n = (name ?? "").trim();
    const r = (region ?? "").trim();
    if (!n) return;

    const items = loadHistory();
    // 同一（店名+地域）は先頭に移動
    const key = `${n}|||${r}`;
    const filtered = items.filter(x => `${x.name}|||${x.region ?? ""}` !== key);
    filtered.unshift({ name: n, region: r, ts: Date.now() });
    const trimmed = filtered.slice(0, 20);
    saveHistory(trimmed);
    renderHistory();
  }

  // --- checkbox UI build ---
  function buildSiteCheckboxes() {
    const prefs = loadSitePrefs(); // null if none
    $sites.innerHTML = "";

    for (const s of SITES) {
      const label = document.createElement("label");
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.dataset.siteId = s.id;

      // default: checked, but if saved prefs exist, follow them
      cb.checked = prefs ? !!prefs[s.id] : true;

      cb.addEventListener("change", () => {
        saveSitePrefs(collectSitePrefsFromUI());
      });

      const span = document.createElement("span");
      span.textContent = s.label;

      label.appendChild(cb);
      label.appendChild(span);
      $sites.appendChild(label);
    }

    // 初回に保存がない場合は、今の状態を保存しておく
    if (!prefs) saveSitePrefs(collectSitePrefsFromUI());
  }

  function selectedSites() {
    const checkedIds = new Set([...$sites.querySelectorAll("input[type=checkbox]:checked")]
      .map(cb => cb.dataset.siteId));
    return SITES.filter(s => checkedIds.has(s.id));
  }

  function generateLinks(fromHistoryClick = false) {
    const name = $q.value.trim();
    const region = $region.value.trim();
    const query = buildQuery(name, region);

    $out.innerHTML = "";
    if (!name) return [];

    const ctx = { name, region, query };
    const links = selectedSites().map(s => ({ label: s.label, url: s.build(ctx) }));

    for (const item of links) {
      const li = document.createElement("li");
      const a = document.createElement("a");
      a.href = item.url;
      a.target = "_blank";
      a.rel = "noopener noreferrer";
      a.textContent = item.label;
      li.appendChild(a);
      $out.appendChild(li);
    }

    // 履歴追加（履歴クリック時も更新してOKだが、無限増殖はしないよう同一は移動）
    addToHistory(name, region);

    return links;
  }

  // --- buttons ---
  document.getElementById("gen").addEventListener("click", () => generateLinks(false));

  document.getElementById("clearHistory").addEventListener("click", () => {
    localStorage.removeItem(STORAGE_KEYS.history);
    renderHistory();
  });

  document.getElementById("checkAll").addEventListener("click", () => {
    for (const cb of $sites.querySelectorAll("input[type=checkbox]")) cb.checked = true;
    saveSitePrefs(collectSitePrefsFromUI());
  });

  document.getElementById("uncheckAll").addEventListener("click", () => {
    for (const cb of $sites.querySelectorAll("input[type=checkbox]")) cb.checked = false;
    saveSitePrefs(collectSitePrefsFromUI());
  });

  // Enterでも生成（店名/地域どちらでも）
  function onEnter(e) { if (e.key === "Enter") generateLinks(false); }
  $q.addEventListener("keydown", onEnter);
  $region.addEventListener("keydown", onEnter);

  // init
  buildSiteCheckboxes();
  renderHistory();
</script>
</body>
</html>
